<!DOCTYPE html>
<html>
<head>
	<meta name="author" content="Yeeku.H.Lee(CrazyIt.org)" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title> 拖动动态改变树结构 </title>
	<!-- 导入Ext JS必需的CSS样式单 -->
	<link href="extjs/resources/css/ext-all.css" rel="stylesheet" type="text/css" />
	<!-- 导入Ext JS必需的JavaScript库 -->
	<script type="text/javascript" src="extjs/ext-all.js">
	</script>
	<!-- 导入Ext JS国际化所需的JavaScript库 -->
	<script type="text/javascript" src="extjs/ext-lang-zh_CN.js">
	</script>
</head>
<body>
<script type="text/javascript">
Ext.onReady(function(){
	//禁止整个页面的右键
	Ext.getDoc().on("contextmenu", function(e){
		e.stopEvent();
	});
	// 定义一个Model类
	Ext.define('Employee', {
		extend: 'Ext.data.Model',
		// 定义该Model类包含的所有列
		fields: [
			{name: 'id',  type: 'int'},
			// 将原来的name属性映射成text列
			{name: 'text',   type: 'string' , mapping:"name"},
			{name: 'desc', type: 'string'},
			{name: 'mgrId', type: 'int'}
		]
	});
	// 创建Ext.data.TreeStore
	treeStore = Ext.create('Ext.data.TreeStore', {
		model: Employee,
		proxy: {
			type: 'ajax', // 指定使用Ajax请求
			url: 'getChildrenNodes', // 向该URL发送请求
			reader: {
				type: 'json',
				root: 'data' // 指定读取data属性
			}
		},
	});
	var tree = Ext.create('Ext.tree.Panel', {
		title: '拖动动态改变树结构',
		useArrows: false,
		width: 300,
		height: 450,
		store: treeStore,
		rootVisible: false,
		// 通过viewConfig指定该树支持拖放
		viewConfig: {
			plugins: {
				ptype: 'treeviewdragdrop',
			}
		},
		renderTo: Ext.getBody()
	});
	// dropPosition代表拖放的位置，有"before", "after" or "append"3个值。
	// data的records代表正在被拖动的Model
	// overModel代表放下的节点
	tree.view.on('drop' , function(node, data, overModel, dropPosition)
	{
		// 如果拖动成子节点
		if(dropPosition == 'append')
		{
			mgrId = overModel.data.id;
		}
		// 如果拖动成兄弟节点
		else if(dropPosition == 'before' ||
			dropPosition == 'after')
		{
			mgrId = overModel.parentNode.data.id;
		}
		Ext.Ajax.request({
			url: 'updateNode',// 向该URL发送请求
			// 请求被拖动节点ID、父节点ID作为请求参数发送过去
			params: {
				id: data.records[0].data.id,
				mgrId: mgrId
			},
			success: function(response){
				var data = Ext.decode(response.responseText);
				alert(data.tip);
			}
		});
	});
});
</script>
</body>
</html>
